
{% extends "MenuPrincipal.html" %}
<body>
{% block content %}

{% load humanize %}
{% load static %}


<div class="container-fluid mt-3">

    <!-- 1. SECCIÓN SUPERIOR: BÚSQUEDA DEL EXPEDIENTE -->
    <div class="card shadow-sm mb-3 border-success">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-cash-coin me-2"></i>Captura de cuotas voluntarias recibidas</h5>
        </div>
        <div class="card-body bg-light">
            <form method="GET" action="" id="formBusqueda">
                <div class="row align-items-end">
                    <!-- Selector de Expediente -->
                    <div class="col-md-2">
                        <label for="selectExpediente" class="form-label fw-bold text-success">Expediente</label>
                        <select class="form-select" id="selectExpediente" name="q_expediente" onchange="this.form.submit()">
                            <option value="">Seleccionar...</option>
                            {% for p in pacientes_lista %}
                                <option value="{{ p.id }}" {% if interno_seleccionado.id == p.id %}selected{% endif %}>
                                    {{ p.numeroexpediente }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Selector de Nombre (Sincronizado) -->
                    <div class="col-md-8">
                        <label for="selectNombre" class="form-label fw-bold text-success">Nombre completo</label>
                        <select class="form-select" id="selectNombre" onchange="document.getElementById('selectExpediente').value=this.value; this.form.submit()">
                            <option value="">Buscar por nombre...</option>
                            {% for p in pacientes_lista %}
                                <option value="{{ p.id }}" {% if interno_seleccionado.id == p.id %}selected{% endif %}>
                                    {{ p.nombrecompleto }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Foto o Info extra (como en la imagen original hay un recuadro blanco) -->
                    <div class="col-md-2 text-center">
                         {% if interno_seleccionado %}
                            <div class="border bg-white p-2 rounded text-muted small">
                                <strong>Saldo Actual:</strong><br>
                                <span class="h5 text-danger">${{ interno_seleccionado.saldo|intcomma }}</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 2. SECCIÓN MEDIA: TABLA DE ESTADO DE CUENTA (EL GRID) -->
    <div class="card shadow-sm mb-3" style="min-height: 300px;">
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                <table class="table table-striped table-hover mb-0 table-bordered">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th style="width: 15%;">Fecha</th>
                            <th style="width: 45%;">Referencia / Concepto</th>
                            <th style="width: 20%;" class="text-end">Importe (Cargo)</th>
                            <th style="width: 20%;" class="text-end">Abono (Pago)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if movimientos %}
                            {% for mov in movimientos %}
                            <tr>
                                <td>{{ mov.fecha|date:"d/m/Y" }}</td>
                                <td><small class="text-muted">{{ mov.referencia }}</small></td>
                                <td class="text-end text-danger">
                                    {% if mov.tipo == "C" %}${{ mov.importe|intcomma }}{% endif %}
                                </td>
                                <td class="text-end text-success">
                                    {% if mov.tipo == "A" %}${{ mov.importe|intcomma }}{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <!-- Estado vacío como en la imagen -->
                            <tr>
                                <td colspan="4" class="text-center py-5 text-muted">
                                    <br>
                                    <h5>&lt; No hay datos para mostrar &gt;</h5>
                                    <p class="small">Seleccione un expediente para ver su historial.</p>
                                    <br>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 3. SECCIÓN INFERIOR: FORMULARIO DE CAPTURA (Estilo Visual Imagen) -->
    {% if interno_seleccionado %}
    <div class="card shadow border-success" style="border-radius: 15px; border-width: 2px;">
        <div class="card-body bg-light" style="border-radius: 13px;"> <!-- Fondo suave -->

            <form method="POST" action="{% url 'guardar_pago' interno_seleccionado.id %}">
                {% csrf_token %}

                <div class="row align-items-center">
                <div class="col-md-8 px-4">
                   <div class="row mb-2 align-items-center">
                   <label class="col-sm-3 col-form-label fw-bold text-end text-success">Concepto:</label>
                   <div class="col-sm-9">
                   <select class="form-select" name="concepto" required max-length="100">
                       <!-- Opción vacía por si acaso (opcional) -->
                    <option value="">Seleccione...</option>

                   {% for codigo, nombre in lista_conceptos %}
                      <option value="{{ codigo }}"
                        {% if codigo == '2' or codigo == 2 %}selected{% endif %}>
                    {{ nombre }}
                       </option>
                    {% endfor %}
                  </select>
               </div>
              </div>
              </div>


                    <!-- COLUMNA CENTRAL: CAMPOS DE CAPTURA -->
                    <div class="col-md-8 px-4">

                        <!-- Fila 1: Recibimos de -->
                        <div class="row mb-2 align-items-center">
                            <label class="col-sm-3 col-form-label fw-bold text-end text-success">Recibimos de:</label>
                            <div class="col-sm-9">
                                <!-- Por defecto pone el nombre del interno, pero es editable -->
                                <input type="text" class="form-control" name="recibido_de"
                                       value="{{ interno_seleccionado.responsable }}" required>
                            </div>
                        </div>

                        <!-- Fila 2: Importe y Fecha -->
                        <div class="row mb-2 align-items-center">
                            <label class="col-sm-3 col-form-label fw-bold text-end text-success">Importe :</label>
                            <div class="col-sm-3">
                                <div class="input-group">
                                    <span class="input-group-text bg-white text-success fw-bold">$</span>
                                    <input type="number" class="form-control fw-bold" name="importe" step="0.01" required placeholder="0.00">
                                </div>
                            </div>

                            <label class="col-sm-2 col-form-label fw-bold text-end text-success">Fecha:</label>
                            <div class="col-sm-4">
                                <input type="date" class="form-control" name="fecha_pago" value="{% now 'Y-m-d' %}" required>
                            </div>
                        </div>

                        <!-- Fila 3: Periodo -->
                        <div class="row mb-2 align-items-center">
                            <label class="col-sm-3 col-form-label fw-bold text-end text-success">Periodo del:</label>
                            <div class="col-sm-4">
                                <input type="date" class="form-control form-control-sm" name="periodo_inicio">
                            </div>
                            <div class="col-sm-1 text-center fw-bold text-success">Al:</div>
                            <div class="col-sm-4">
                                <input type="date" class="form-control form-control-sm" name="periodo_fin">
                            </div>
                        </div>

                        <!-- Fila 4: Observaciones -->
                        <div class="row mb-1 align-items-center">
                            <label class="col-sm-3 col-form-label fw-bold text-end text-success">Observaciones:</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" name="observaciones">
                            </div>
                        </div>

                    </div>

                    <!-- COLUMNA DERECHA: BOTÓN GUARDAR -->
                    <div class="col-md-2 text-center border-start border-success">
                        <button type="submit" class="btn btn-success rounded-circle shadow p-0 d-flex align-items-center justify-content-center mx-auto"
                                style="width: 80px; height: 80px; transition: transform 0.2s;"
                                onmouseover="this.style.transform='scale(1.1)'"
                                onmouseout="this.style.transform='scale(1.0)'">
                            <i class="bi bi-check-lg" style="font-size: 3.5rem;"></i>
                        </button>
                        <div class="mt-2 fw-bold text-success">APLICAR</div>
                    </div>

                </div>
            </form>
        </div>
    </div>
    {% else %}
        <div class="alert alert-warning text-center mt-4">
            <i class="bi bi-arrow-up-circle me-2"></i> Por favor seleccione un expediente arriba para capturar un pago.
        </div>
    {% endif %}

</div>
{% if recibo_id_imprimir %}
<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        // Asegúrate de que la URL 'imprimir_recibo' ahora apunte a la vista que consulta el modelo Recibos
        var urlRecibo = "{% url 'imprimir_recibo' id_recibo=recibo_id_imprimir %}";

        window.open(urlRecibo, '_blank', 'width=800,height=600,scrollbars=yes');
    });
</script>
{% endif %}
<!-- Estilos extra para pulir detalles visuales -->
<style>
    /* Quitar flechas de input number */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    input[type=number] {
        -moz-appearance: textfield;
    }

    /* Inputs con foco verde */
    .form-control:focus, .form-select:focus {
        border-color: #198754;
        box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25);
    }
</style>

{% endblock %}


