{% extends "dgenerales.html" %}

<body>
{% block content %}
{% load forms_tags %}
{% load custom_filters %}
{% load form_utils %}

<div class="interview-container">
  <!-- Header Sticky -->
  <div class="header-content sticky-top">
    <div class="header-title">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h3>Nota de Evolución Psicológica #
           {{ numero_sesion_actual }}

          </h3>
        </div>
        <div>
          <!-- Botón Regresar -->
          <a href="{% url 'listaSesionesPS' id=interno.numeroexpediente %}"
                   class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i> Regresar al Listado
          </a>
        </div>
      </div>

      <!-- Información del paciente -->
      <div class="patient-info d-flex justify-content-between align-items-center flex-wrap">
        <div class="d-flex flex-wrap align-items-center gap-3">
          <div class="patient-id">
            <span class="badge bg-secondary">Expediente:</span>
            <span class="fw-bold">{{ interno.numeroexpediente }}</span>
          </div>
          <div class="patient-name">
            <span class="badge bg-secondary">Nombre:</span>
            <span class="fw-bold">{{ interno.nombrecompleto }}</span>
          </div>
        </div>

        <!-- Elementos de la derecha -->
        <div class="d-flex align-items-center gap-3">
          <div class="fecha-sesion">
            <span class="badge bg-primary">Fecha:</span>
            <span>{{ instancia_sesion.fecha|default:form.fecha.value }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulario principal -->
  <form action="{% if accion == 'editar' and instancia_sesion %}
                {% url 'capturaSesionPS_con_id' accion='editar' id=interno.pk no_sesion=instancia_sesion.pk %}
                {% else %}
                {% url 'capturaSesionPS' accion='agregar' id=interno.pk %}
                {% endif %}"
        method="POST"
        class="needs-validation"
        novalidate
        id="sesionForm">
    {% csrf_token %}

    <!-- Campo oculto para el status -->
    <input type="hidden" name="status" id="statusField" value="0">
    <input type="hidden" name="expediente" value="{{ interno.numeroexpediente }}">
{% if form.errors %}
<div class="alert alert-danger">
    <h5>Errores detallados:</h5>
    <ul>
        {% for field, errors in form.errors.items %}
            <li><strong>{{ field }}:</strong> {{ errors|join:", " }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}
    <!-- Mensajes de alerta -->
    {% if messages %}
    <div class="alert-messages mt-3">
      {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        <i class="bi bi-info-circle me-2"></i>{{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Sección de captura -->
    <div class="card shadow-sm mt-3">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Detalles de la Sesión</h5>
        {% if instancia_sesion and instancia_sesion.status == 1 %}
        <span class="badge bg-warning text-dark">
          <i class="bi bi-lock-fill me-1"></i> Sesión Cerrada
        </span>
        {% endif %}
      </div>

      <div class="card-body">
        <!-- Información básica de la sesión (SOLO FECHA) -->
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="{{ form.fecha.id_for_label }}" class="form-label fw-bold">
              {{ form.fecha.label }} *
            </label>
            {{ form.fecha|add_class:"form-control form-control-sm" }}
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold">¿Se lograron los objetivos?</label>
            <div class="form-check form-switch mt-2">
              {{ form.selograron }}
              <label class="form-check-label" for="{{ form.selograron.id_for_label }}">
                {{ form.selograron.label }}
              </label>
            </div>
          </div>
        </div>

        <!-- Contenido de la sesión -->
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="{{ form.objetivo.id_for_label }}" class="form-label fw-bold">
              {{ form.objetivo.label }}
            </label>
            <div class="form-text small">Objetivo principal de esta sesión</div>
            {{ form.objetivo|add_class:"form-control form-control-sm" }}
          </div>
          <div class="col-md-6 mb-3">
            <label for="{{ form.resumen.id_for_label }}" class="form-label fw-bold">
              {{ form.resumen.label }}
            </label>
            <div class="form-text small">Resumen de lo tratado en la sesión</div>
            {{ form.resumen|add_class:"form-control form-control-sm" }}
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="{{ form.objetivoyplan.id_for_label }}" class="form-label fw-bold">
              {{ form.objetivoyplan.label }}
            </label>
            <div class="form-text small">Objetivo y plan terapéutico</div>
            {{ form.objetivoyplan|add_class:"form-control form-control-sm" }}
          </div>
          <div class="col-md-6 mb-3">
            <label for="{{ form.actividades.id_for_label }}" class="form-label fw-bold">
              {{ form.actividades.label }}
            </label>
            <div class="form-text small">Actividades realizadas</div>
            {{ form.actividades|add_class:"form-control form-control-sm" }}
          </div>
        </div>

        <!-- Resultados y Observaciones -->
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="{{ form.resultado.id_for_label }}" class="form-label fw-bold">
              {{ form.resultado.label }}
            </label>
            <div class="form-text small">Resultados obtenidos</div>
            {{ form.resultado|add_class:"form-control form-control-sm" }}
          </div>
          <div class="col-md-6 mb-3">
            <label for="{{ form.observaciones.id_for_label }}" class="form-label fw-bold">
              {{ form.observaciones.label }}
            </label>
            <div class="form-text small">Observaciones adicionales</div>
            {{ form.observaciones|add_class:"form-control form-control-sm" }}
          </div>
        </div>

        <!-- Campos al final: Tipo de sesión (select) y número de sesión/psicólogo (readonly) -->
        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="{{ form.individualogrupal.id_for_label }}" class="form-label fw-bold">
              {{ form.individualogrupal.label }}
            </label>
            {{ form.individualogrupal|add_class:"form-select form-select-sm" }}
          </div>
          <div class="col-md-4 mb-3">
            <label for="{{ form.sesion.id_for_label }}" class="form-label fw-bold">
              {{ form.sesion.label }}
            </label>
            {{ form.sesion|add_class:"form-control form-control-sm" }}
            <div class="form-text small">Número automático</div>
          </div>
          <div class="col-md-4 mb-3">
            <label for="{{ form.psicologo.id_for_label }}" class="form-label fw-bold">
              {{ form.psicologo.label }}
            </label>
            {{ form.psicologo|add_class:"form-control form-control-sm" }}
            <div class="form-text small">Asignado automáticamente</div>
          </div>
        </div>

        <!-- Botones de acción -->
        <div class="d-flex justify-content-between mt-4">
          <div>
            <a href="{% url 'listaSesionesPS' id=interno.numeroexpediente %}"
               class="btn btn-outline-secondary me-2">
              <i class="bi bi-arrow-left me-1"></i> Regresar
            </a>
            <!-- Botón para abrir el modal de cerrar sesión -->
            {% if not instancia_sesion or instancia_sesion.status != 1 %}
            <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#cerrarSesionModal">
              <i class="bi bi-lock me-2"></i> Cerrar Sesión
            </button>
            {% endif %}
          </div>

          <div>
            <button type="submit" class="btn btn-primary" {% if instancia_sesion and instancia_sesion.status == 1 %}disabled{% endif %}>
              <i class="bi bi-save me-2"></i>
              {% if instancia_sesion and instancia_sesion.status == 1 %}
                Sesión Cerrada
              {% else %}
                {% if accion == 'agregar' %}Guardar Sesión{% else %}Actualizar Sesión{% endif %}
              {% endif %}
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Modal para cerrar sesión -->
<div class="modal fade" id="cerrarSesionModal" tabindex="-1" aria-labelledby="cerrarSesionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cerrarSesionModalLabel">Cerrar Sesión</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-warning mb-3">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>¿Está seguro de que desea cerrar esta sesión?</strong>
        </p>
        <p class="text-muted small">
          Al cerrar la sesión, ya no podrá realizar modificaciones a la información capturada.
          Esta acción es irreversible.
        </p>

        <form id="cerrarSesionForm">
          <div class="mb-3">
            <label for="proximasesion" class="form-label fw-bold">
              Fecha de la siguiente sesión  <span class="text-danger">*</span>
            </label>
           <input type="date" class="form-control" id="proxima_sesion_modal" name="proxima_sesion_modal">
            <div class="form-text">Debe especificar la fecha para la próxima sesión.</div>
            <div id="fecha-error" class="alert alert-danger mt-2" style="display: none;"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-2"></i> Cancelar
        </button>
        <button type="button" class="btn btn-warning" id="confirmarCerrarSesion">
          <i class="bi bi-check-circle me-2"></i> Sí, Cerrar Sesión y Programar Próxima
        </button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Validación de formularios
  var forms = document.querySelectorAll('.needs-validation');
  Array.prototype.slice.call(forms).forEach(function(form) {
    form.addEventListener('submit', function(event) {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  });

  // Lógica para cerrar sesión
  document.getElementById('confirmarCerrarSesion').addEventListener('click', function(e) {
    e.preventDefault();

    const fechaSesionInput = '{{ instancia_sesion.fecha|date:"Y-m-d"|default:form.fecha.value|default:"" }}';
    const fechaSesion = fechaSesionInput ? new Date(fechaSesionInput) : new Date();
    const proximaSesionInput = document.querySelector('#proxima_sesion_modal');
    const proximaSesion = proximaSesionInput.value ? new Date(proximaSesionInput.value) : null;
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);

    let error = '';
    if (proximaSesionInput.value) {
       const hiddenInput = document.createElement('input');
       hiddenInput.type = 'hidden';
       hiddenInput.name = 'proximasesion';
       hiddenInput.value = proximaSesionInput.value;
      document.getElementById('sesionForm').appendChild(hiddenInput);
      }
    // Validar que se ingrese una fecha
    if (!proximaSesionInput.value) {
        error = 'Error: Debe especificar una fecha para la próxima sesión al cerrar la sesión actual';
    }
    // Validar que sea posterior a la fecha de la sesión actual
    else if (proximaSesion <= fechaSesion) {
        error = `Error: La próxima sesión debe ser posterior a la fecha de esta sesión ({{ instancia_sesion.fecha|date:"d/m/Y" }})`;
    }
    // Validar que no sea una fecha pasada
    else if (proximaSesion < hoy) {
        error = 'Error: La próxima sesión no puede ser una fecha pasada';
    }

    if (error) {
        // Mostrar error en el modal
        const errorDiv = document.getElementById('fecha-error');
        if (errorDiv) {
            errorDiv.textContent = error;
            errorDiv.style.display = 'block';
        } else {
            alert(error);
        }
        proximaSesionInput.focus();
        return;
    }

    // Si pasa validación, proceder con el cierre
    document.getElementById('statusField').value = '1';
    document.getElementById('sesionForm').submit();
  });

  // Ocultar mensaje de error cuando el usuario modifique la fecha
  const fechaInput = document.querySelector('#id_proximasesion');
  if (fechaInput) {
    fechaInput.addEventListener('input', function() {
      const errorDiv = document.getElementById('fecha-error');
      if (errorDiv) {
        errorDiv.style.display = 'none';
      }
    });
  }

  document.getElementById('cerrarSesionModal').addEventListener('hidden.bs.modal', function () {
    const errorDiv = document.getElementById('fecha-error');
    if (errorDiv) {
      errorDiv.style.display = 'none';
    }
  });

  // Deshabilitar campos si la sesión está cerrada
  {% if instancia_sesion and instancia_sesion.status == 1 %}
  const formControls = document.querySelectorAll('#sesionForm input, #sesionForm textarea, #sesionForm select');
  formControls.forEach(function(control) {
    control.disabled = true;
  });
  {% endif %}
});
</script>

<style>
.interview-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 15px 30px;
}

.header-content {
  background: white;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  padding: 15px 0;
  margin-bottom: 20px;
}

/* Estilos responsive */
@media (max-width: 768px) {
  .interview-container {
    padding: 0 10px;
  }

  .patient-info {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }

  .col-md-6 {
    width: 100%;
  }
}

/* Estilo para el switch del checkbox */
.form-check-input:checked {
  background-color: #198754;
  border-color: #198754;
}

/* Estilo para campos readonly */
.form-control[readonly] {
  background-color: #f8f9fa;
  opacity: 1;
}
</style>

{% endblock %}