{% extends "dgenerales.html" %}

<body>
{% block content %}
{% load forms_tags %}
{% load custom_filters %}
{% load form_utils %}

<div class="interview-container">
  <!-- Header Sticky -->
  <div class="header-content sticky-top">
    <div class="header-title">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h3>Sesión Individual #{{ numero_sesion_actual }}</h3>
        </div>
        <div>
          <!-- Botón Regresar -->
          <a href="{% url 'listaSesionesS' id=interno.numeroexpediente %}"
             class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i> Regresar al Listado
          </a>
        </div>
      </div>

      <!-- Información del paciente -->
      <div class="patient-info d-flex justify-content-between align-items-center flex-wrap">
        <div class="d-flex flex-wrap align-items-center gap-3">
          <div class="patient-id">
            <span class="badge bg-secondary">Expediente:</span>
            <span class="fw-bold">{{ interno.numeroexpediente }}</span>
          </div>
          <div class="patient-name">
            <span class="badge bg-secondary">Nombre:</span>
            <span class="fw-bold">{{ interno.nombrecompleto }}</span>
          </div>
        </div>

        <!-- Elementos de la derecha -->
        <div class="d-flex align-items-center gap-3">
          <div class="fecha-sesion">
            <span class="badge bg-primary">Fecha:</span>
            <span>{{ instancia_sesion.fecha|default:form.fecha.value|date:"d/m/Y" }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulario principal -->
  <form action="{% if accion == 'editar' and instancia_sesion %}
                {% url 'capturaSesionS_con_id' accion='editar' id=interno.numeroexpediente no_sesion=instancia_sesion.pk %}
                {% else %}
                {% url 'capturaSesionS' accion='agregar' id=interno.numeroexpediente %}
                {% endif %}"
        method="POST"
        class="needs-validation"
        novalidate
        id="sesionForm">
    {% csrf_token %}

    <!-- Campos ocultos -->
    <input type="hidden" name="status" id="statusField" value="0">
    <input type="hidden" name="expediente" value="{{ interno.numeroexpediente }}">
    <input type="hidden" name="clinica" value="{{ form.clinica.value }}">

    {% if form.errors %}
    <div class="alert alert-danger">
        <h5>Errores detallados:</h5>
        <ul>
            {% for field, errors in form.errors.items %}
                <li><strong>{{ field }}:</strong> {{ errors|join:", " }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Mensajes de alerta -->
    {% if messages %}
    <div class="alert-messages mt-3">
      {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        <i class="bi bi-info-circle me-2"></i>{{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Sección de captura -->
    <div class="card shadow-sm mt-3">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Detalles de la Sesión</h5>
        {% if instancia_sesion and instancia_sesion.status == 1 %}
        <span class="badge bg-warning text-dark">
          <i class="bi bi-lock-fill me-1"></i> Sesión Cerrada
        </span>
        {% endif %}
      </div>

      <div class="card-body">
        <!-- Información básica de la sesión -->
        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="{{ form.fecha.id_for_label }}" class="form-label fw-bold">
              {{ form.fecha.label }} *
            </label>
            {{ form.fecha|add_class:"form-control form-control-sm" }}
          </div>
          <div class="col-md-4 mb-3">
            <label for="{{ form.sesion.id_for_label }}" class="form-label fw-bold">
              {{ form.sesion.label }}
            </label>
            {{ form.sesion|add_class:"form-control form-control-sm" }}
            <div class="form-text small">Número automático</div>
          </div>

         <div class="col-md-4 mb-3 ">
         <i class="bi bi-person-badge-fill me-1">  Consejero:</i>

        <div class="d-block w-200 px-3 py-2 rounded-3 bg-primary bg-opacity-10 text-primary fw-medium border border-primary border-opacity-10 text-truncate">
            <span class="text-dark fw-bold">{{ form.instance.nombreconsejero|default:"--" }}</span>
        </div>

  {{form.consejero.as_hidden}}
  {{form.nombreconsejero.as_hidden}}

        </div>


        </div>

        <!-- Objetivo -->
        <div class="row">
          <div class="col-12 mb-3">
            <label for="{{ form.objetivo.id_for_label }}" class="form-label fw-bold">
              {{ form.objetivo.label }}
            </label>

            {{ form.objetivo|add_class:"form-control form-control-sm" }}
          </div>
        </div>

        <!-- Consumo de sustancias -->
        <div class="row">
          <div class="col-12 mb-3">
            <label for="{{ form.consumodesustancias.id_for_label }}" class="form-label fw-bold">
              {{ form.consumodesustancias.label }}
            </label>
            {{ form.consumodesustancias|add_class:"form-control form-control-sm" }}
          </div>
        </div>

        <!-- Plan de acción -->
        <div class="row">
          <div class="col-12 mb-3">
            <label for="{{ form.plandeaccion.id_for_label }}" class="form-label fw-bold">
              {{ form.plandeaccion.label }}
            </label>
            {{ form.plandeaccion|add_class:"form-control form-control-sm" }}
          </div>
        </div>

        <!-- Tareas -->
        <div class="row">
          <div class="col-12 mb-3">
            <label for="{{ form.tareas.id_for_label }}" class="form-label fw-bold">
              {{ form.tareas.label }}
            </label>
            {{ form.tareas|add_class:"form-control form-control-sm" }}
          </div>
        </div>

        <!-- Aspectos a revisar -->
        <div class="row">
          <div class="col-12 mb-3">
            <label for="{{ form.aspectosqueserevisaran.id_for_label }}" class="form-label fw-bold">
              {{ form.aspectosqueserevisaran.label }}
            </label>
            {{ form.aspectosqueserevisaran|add_class:"form-control form-control-sm" }}
          </div>
        </div>

        <!-- Observaciones -->
        <div class="row">
          <div class="col-12 mb-3">
            <label for="{{ form.observaciones.id_for_label }}" class="form-label fw-bold">
              {{ form.observaciones.label }}
            </label>
            {{ form.observaciones|add_class:"form-control form-control-sm" }}
          </div>
        </div>

        <!-- Próxima sesión -->


        <!-- Botones de acción -->
        <div class="d-flex justify-content-between mt-4">
          <div>
            <a href="{% url 'listaSesionesS' id=interno.numeroexpediente %}"
               class="btn btn-outline-secondary me-2">
              <i class="bi bi-arrow-left me-1"></i> Regresar
            </a>
            <!-- Botón para abrir el modal de cerrar sesión -->
            {% if not instancia_sesion or instancia_sesion.status != 1 %}
            <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#cerrarSesionModal">
              <i class="bi bi-lock me-2"></i> Cerrar Sesión
            </button>
            {% endif %}
          </div>

          <div>
            <button type="submit" class="btn btn-primary" {% if instancia_sesion and instancia_sesion.status == 1 %}disabled{% endif %}>
              <i class="bi bi-save me-2"></i>
              {% if instancia_sesion and instancia_sesion.status == 1 %}
                Sesión Cerrada
              {% else %}
                {% if accion == 'agregar' %}Guardar Sesión{% else %}Actualizar Sesión{% endif %}
              {% endif %}
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Modal para cerrar sesión -->
<div class="modal fade" id="cerrarSesionModal" tabindex="-1" aria-labelledby="cerrarSesionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cerrarSesionModalLabel">Cerrar Sesión</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-warning mb-3">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>¿Está seguro de que desea cerrar esta sesión?</strong>
        </p>
        <p class="text-muted small">
          Al cerrar la sesión, ya no podrá realizar modificaciones a la información capturada.
          Esta acción es irreversible.
        </p>

        <form id="cerrarSesionForm">
          <div class="mb-3">
            <label for="proximasesion" class="form-label fw-bold">
              Fecha de la siguiente sesión <span class="text-danger">*</span>
            </label>
            <input type="date" class="form-control" id="proxima_sesion_modal" name="proxima_sesion_modal">
            <div class="form-text">Debe especificar la fecha para la próxima sesión.</div>
            <div id="fecha-error" class="alert alert-danger mt-2" style="display: none;"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-2"></i> Cancelar
        </button>
        <button type="button" class="btn btn-warning" id="confirmarCerrarSesion">
          <i class="bi bi-check-circle me-2"></i> Sí, Cerrar Sesión y Programar Próxima
        </button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Validación de formularios
  var forms = document.querySelectorAll('.needs-validation');
  Array.prototype.slice.call(forms).forEach(function(form) {
    form.addEventListener('submit', function(event) {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  });

  // Lógica para cerrar sesión
  document.getElementById('confirmarCerrarSesion').addEventListener('click', function(e) {
    e.preventDefault();

    const fechaSesionInput = '{{ instancia_sesion.fecha|date:"Y-m-d"|default:form.fecha.value|default:"" }}';
    const fechaSesion = fechaSesionInput ? new Date(fechaSesionInput) : new Date();
    const proximaSesionInput = document.querySelector('#proxima_sesion_modal');
    const proximaSesion = proximaSesionInput.value ? new Date(proximaSesionInput.value) : null;
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);

    let error = '';

    // Validar que se ingrese una fecha
    if (!proximaSesionInput.value) {
        error = 'Error: Debe especificar una fecha para la próxima sesión al cerrar la sesión actual';
    }
    // Validar que sea posterior a la fecha de la sesión actual
    else if (proximaSesion <= fechaSesion) {
        error = `Error: La próxima sesión debe ser posterior a la fecha de esta sesión ({{ instancia_sesion.fecha|date:"d/m/Y"|default:form.fecha.value|date:"d/m/Y" }})`;
    }
    // Validar que no sea una fecha pasada
    else if (proximaSesion < hoy) {
        error = 'Error: La próxima sesión no puede ser una fecha pasada';
    }

    if (error) {
        // Mostrar error en el modal
        const errorDiv = document.getElementById('fecha-error');
        if (errorDiv) {
            errorDiv.textContent = error;
            errorDiv.style.display = 'block';
        } else {
            alert(error);
        }
        proximaSesionInput.focus();
        return;
    }

    // Si pasa validación, proceder con el cierre
    document.getElementById('statusField').value = '1';

    // Agregar la fecha de próxima sesión al formulario principal
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'proximasesion';
    hiddenInput.value = proximaSesionInput.value;
    document.getElementById('sesionForm').appendChild(hiddenInput);

    document.getElementById('sesionForm').submit();
  });

  // Ocultar mensaje de error cuando el usuario modifique la fecha
  const fechaInput = document.querySelector('#proxima_sesion_modal');
  if (fechaInput) {
    fechaInput.addEventListener('input', function() {
      const errorDiv = document.getElementById('fecha-error');
      if (errorDiv) {
        errorDiv.style.display = 'none';
      }
    });
  }

  document.getElementById('cerrarSesionModal').addEventListener('hidden.bs.modal', function () {
    const errorDiv = document.getElementById('fecha-error');
    if (errorDiv) {
      errorDiv.style.display = 'none';
    }
  });

  // Deshabilitar campos si la sesión está cerrada
  {% if instancia_sesion and instancia_sesion.status == 1 %}
  const formControls = document.querySelectorAll('#sesionForm input, #sesionForm textarea, #sesionForm select');
  formControls.forEach(function(control) {
    control.disabled = true;
  });
  {% endif %}
});
</script>

<style>
.interview-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 15px 30px;
}

.header-content {
  background: white;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  padding: 15px 0;
  margin-bottom: 20px;
}

/* Estilos responsive */
@media (max-width: 768px) {
  .interview-container {
    padding: 0 10px;
  }

  .patient-info {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }

  .col-md-6 {
    width: 100%;
  }
}

/* Estilo para campos readonly */
.form-control[readonly] {
  background-color: #f8f9fa;
  opacity: 1;
}
</style>

{% endblock %}