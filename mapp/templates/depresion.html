{% extends "dgenerales.html" %}
<body>
{% block content %}
{% load forms_tags %}
{% load custom_filters %}
{% load form_utils %}

<div class="interview-container">
  <!-- Header Sticky -->

  <div class="header-content">
  <div class="header-title">
    <h3>Sintomas de depresion <span class="badge bg-primary rounded-pill">{{ depresionf.instance.deppuntos|default:"0" }}  Puntos</span> </h3>
  <!-- CÓDIGO CORREGIDO Y RECOMENDADO -->
<div class="patient-info d-flex align-items-center">
    <!-- Información del paciente (se queda igual) -->
    <div>
        <div class="patient-id d-inline-block me-3">
            <label>Expediente:</label>
            <span>{{ interno.numeroexpediente }}</span>
        </div>
        <div class="patient-name d-inline-block">
            <label>Nombre:</label>
            <span>{{ interno.nombrecompleto }}</span>
        </div>
    </div>

    <!-- Contenedor para los elementos de la derecha -->
    <!-- 'ms-auto' empuja todo este bloque a la derecha -->
    <!-- 'd-flex align-items-center gap-3' organiza los elementos internos -->
   <!--  para ver si  <div class="ms-auto d-flex align-items-center gap-3"> -->

        <!-- TU DIV DE LA FECHA, AHORA SIN ESTILOS INCORRECTOS -->
        <div>Fecha: {{ depresionf.depfecha }}</div>

        <!-- El botón "Regresar" -->
        <a href="{% url 'seleccionainterno' id=interno.pk %}?opcion=seleccionar"
           class="btn btn-primary"
           style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem;">
           Regresar
        </a>
    </div>
</div>
  </div>
</div>


  <!-- Contenido del formulario -->
  <form action="{% url 'graba-depresion' id=interno.pk %}" method="POST" >
    {% csrf_token %}
    {{depresionf.deppuntos}}
    {% if messages %}
    <div class="alert-messages">
      {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      {% endfor %}
    </div>
    {% endif %}


  <!-- Sección 2: Escala de valoración familiar -->
  <div class="card shadow-sm" style="background-color:white;">
    <div class="card-header ">
      <p class="bg-primary text-white">En este cuestionario se encuentran 21 grupos de oraciones. Por favor lea cada una cuidadosamente y escoja la oración que mejor describa la manera en que
se sintió la semana pasada o inclusive el día de hoy. Para ello, encierre en un círculo el número que se encuentra al lado de la oración que usted escogió.
Asegúrese de leer todas las oraciones en cada grupo antes de hacer su elección.

    </p>

      <div style="background-color:white;color:black;">

{% for i in "1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21"|split:"," %}
    {% get_form_field depresionf "dep"|add:i as campo %}

    <div class="row align-items-center {% cycle '' 'bg-body-secondary' %} ms-2 me-2 mt-4 mb-4" style="font-size:0.90rem;">

        {# Este bucle interior ahora utiliza correctamente la cuadrícula de Bootstrap #}
        {% for choice in campo %}
            <div class="col-md-3">
                <div class="form-check form-check-inline">
                    {{ choice.tag }}
                    <label class="form-check-label" for="{{ choice.id_for_label }}">
                        {{ choice.choice_label }}
                    </label>
                </div>
            </div>
        {% endfor %}

    </div>
{% endfor %}




<div class="d-flex justify-content-between align-items-center mt-4">
    <!-- Este es el nuevo bloque para la puntuación -->
    <div class="card p-3 shadow-sm sticky-top" style="z-index: 1020;">
        <h5>Puntuación Total: <span id="puntuacion-total" class="fw-bold text-primary">0</span></h5>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary btn-save">
        <i class="bi bi-save"></i> Guardar
      </button>
    </div>
</div>
  </div>
   </div>
  </div>
  </form>
</div>

</body>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Espera a que todo el contenido HTML de la página se haya cargado.
document.addEventListener('DOMContentLoaded', function() {

    // --- SELECCIÓN DE ELEMENTOS ---
    // Guardamos las referencias a los elementos que vamos a manipular para no tener que buscarlos cada vez.

    // 1. El lugar donde el USUARIO ve la puntuación.
    // Buscamos el <span> por su ID.
    const displayPuntuacion = document.getElementById('puntuacion-total');

    // 2. El campo OCULTO del formulario donde se GUARDA la puntuación.
    // Buscamos el <input type="hidden"> por el ID que definimos en forms.py.
    const campoOcultoPuntuacion = document.getElementById('id_depresionf_deppuntos');

    // 3. TODOS los radio buttons de las preguntas de psicosis (cuyo 'name' empieza con 'pp').
    const todosLosRadios = document.querySelectorAll("input[name^='dep'][type='radio']");


    // --- FUNCIÓN PRINCIPAL ---
    // Esta función se encarga de calcular y actualizar la puntuación.
    function calcularYActualizarPuntuacion() {
        let puntuacionTotal = 0;

        // Filtramos para obtener solo los radios que están seleccionados.
        const radiosSeleccionados = document.querySelectorAll("input[name^='dep'][type='radio']:checked");

        // Recorremos solo los seleccionados y sumamos su valor.
        radiosSeleccionados.forEach(function(radio) {
            // parseInt convierte el valor (que es un string) en un número.
            // || 0 es una seguridad: si el valor no es un número, suma 0.
            puntuacionTotal += parseInt(radio.value, 10) || 0;
        });

        // --- Actualización de los elementos ---

        // Actualizamos el <span> VISIBLE para el usuario.
        if (displayPuntuacion) {
            displayPuntuacion.textContent = puntuacionTotal;
        }

        // Actualizamos el valor del campo OCULTO del formulario.
        // ESTO ES CRUCIAL PARA QUE EL DATO SE GUARDE.
        if (campoOcultoPuntuacion) {
            campoOcultoPuntuacion.value = puntuacionTotal;
        }
    }


    // --- ADJUNTAR "ESCUCHADORES DE EVENTOS" ---
    // Hacemos que la función se ejecute cada vez que el usuario haga un cambio.
    todosLosRadios.forEach(function(radio) {
        // 'change' es el evento que se dispara cuando se selecciona una nueva opción.
        radio.addEventListener('change', calcularYActualizarPuntuacion);
    });


    // --- CÁLCULO INICIAL ---
    // Ejecutamos la función una vez al cargar la página.
    // Esto es muy importante para que la puntuación se calcule correctamente
    // si el formulario se carga con datos ya guardados.
    calcularYActualizarPuntuacion();
});
</script>

<!-- Estilos personalizados -->
<style>
.interview-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 15px;
}

.interview-header {
  background: white;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  z-index: 1020;
  padding: 15px 0;
  width: 100%;
}



.interview-title {
  font-size: 1.2rem;
  color: #333;
  font-weight: bold;
  margin: 0;
  text-align: right;
}

.patient-info {
  display: flex;
  gap: 20px;
}

.patient-id, .patient-name {
  display: flex;
  align-items: center;
  gap: 5px;
}

.patient-name {
  font-size: 1.2rem;
  font-weight: bold;
}

.interview-tabs {
  margin-top: 15px;
}

.nav-tabs {
  overflow-x: auto;
  white-space: nowrap;
  flex-wrap: nowrap;
}

.nav-link {
  font-weight: 500;
}

.consumo-table {
  margin-top: 20px;
  background: white;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.additional-fields {
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  padding: 10px;
  margin-top: 10px;
}

.additional-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.field-label {
  width: 15%;
  font-weight: 500;
}

.field-value {
  flex: 1;
}

.switch-field {
  display: flex;
  align-items: center;
}

.other-substances {
  display: flex;
  gap: 10px;
  align-items: center;
}

.consequences-container {
  margin-top: 20px;
}

.section-header {
  margin-bottom: 20px;
}

.section-header h4 {
  color: #333;
  font-weight: 600;
}

.instructions {
  display: flex;
  align-items: center;
  gap: 5px;
  color: #6c757d;
  font-size: 0.9rem;
  margin-top: 5px;
}

.consequence-section {
  background: white;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.section-title {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid #eee;
}

.section-title h5 {
  margin: 0;
  font-weight: 600;
  color: #495057;
}

.consequence-item {
  display: flex;
  flex-wrap: wrap;
  margin-bottom: 15px;
  padding-bottom: 15px;
  border-bottom: 1px dashed #eee;
}

.consequence-item:last-child {
  border-bottom: none;
}

.consequence-question {
  width: 100%;
  margin-bottom: 10px;
  font-weight: 500;
}

.consequence-options {
  width: 100%;
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}

.yes-no-options {
  flex: 1;
  display: flex;
  gap: 15px;
}

.severity-options {
  flex: 2;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.other-item {
  background: #f8f9fa;
  padding: 10px;
  border-radius: 4px;
}

.form-actions {
  margin-top: 30px;
  text-align: right;
}

.btn-save {
  padding: 10px 25px;
  font-size: 1rem;
}

/* Responsive */
@media (max-width: 768px) {
  .header-content {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }

  .patient-info {
    flex-direction: column;
    gap: 5px;
    width: 100%;
  }

  .additional-row, .other-substances {
    flex-direction: column;
    gap: 5px;
  }

  .field-label {
    width: 100%;
  }

  .consequence-item {
    flex-direction: column;
  }

  .consequence-options {
    flex-direction: column;
    gap: 10px;
  }

  .yes-no-options, .severity-options {
    width: 100%;
  }
}

  /* Estilos personalizados para esta sección */
  .scale-card {
    background-color: #f8f9fa;
    border-radius: 10px;
    border-left: 4px solid #4e73df;
  }

  .problem-type-card {
    background-color: #f0f7ff;
    border-radius: 10px;
    border-left: 4px solid #1cc88a;
  }

  .radio-indicator {
    width: 20px;
    height: 20px;
    border: 2px solid #d1d3e2;
    border-radius: 50%;
    transition: all 0.3s;
  }

  .custom-control-input:checked ~ .custom-control-label .radio-indicator {
    background-color: #4e73df;
    border-color: #4e73df;
  }

  .option-text {
    font-size: 0.95rem;
  }

    /* Efecto hover y selección para las cards */
    .btn-check:checked + .card {
        border-color: #0d6efd !important;
        background-color: rgba(13, 110, 253, 0.1);
    }
    .btn-check:focus + .card {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    .cursor-pointer {
        cursor: pointer;
    }
    /* Asegurar que el texto no se desborde */
    .card-body span {
        word-break: break-word;
    }
.bg-hover:hover {
    background-color: #e9f5ff;  /* Azul claro */
    transition: background-color 0.3s;
}

/* Estilos para el menú sticky secundario */
.position-sticky {
  position: -webkit-sticky;
  position: sticky;
  top: 0;
  background: white;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  z-index: 1020;
}

.interno-tabs {
  margin-top: 0;
}

.interno-tabs .nav-tabs {
  border-bottom: 1px solid #dee2e6;
}

.interno-tabs .nav-link {
  padding: 0.5rem 1rem;
  font-size: 0.9rem;
}

/* Asegurar que el contenido no quede oculto detrás del sticky */
.tab-content {
  padding-top: 10px;
}


</style>


{% endblock %}