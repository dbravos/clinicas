{% extends "dgenerales.html" %}

<body>
{% block content %}
{% load forms_tags %}
{% load custom_filters %}
{% load form_utils %}

<div class="interview-container">
  <!-- Header Sticky -->
  <div class="header-content sticky-top">
    <div class="header-title">
      <div class="d-flex justify-content-between align-items-start">
          <h3>Hoja de Atención Psicológica</h3>
        <div>
          <!-- Botón Regresar -->
          <a href="{% url 'seleccionainterno' id=interno.pk %}"
                   class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i> Regresar
          </a>
        </div>
      </div>

      <!-- Información del paciente -->
      <div class="medical-badge">
        <div class="medical-header">
            <div class="patient-id">
                <span class="id-label">EXPEDIENTE</span>
                <span class="id-number">{{ interno.numeroexpediente }}</span>
            </div>
            <div class="patient-name">{{ interno.nombrecompleto }}</div>
        </div>

        <div class="medical-data">
            <div class="data-row">
                <div class="data-point">
                    <span class="data-label">Sexo</span>
                    <span class="data-value">{{ interno.get_sexo_display }}</span>
                </div>
                <div class="data-point">
                    <span class="data-label">Edad</span>
                    <span class="data-value">{{ interno.edad }}</span>
                </div>
                <div class="data-point">
                    <span class="data-label">Estado Civil</span>
                    <span class="data-value">{{ interno.get_estadocivil_display }}</span>
                </div>
            </div>
            <div class="data-point-full d-flex justify-content-between align-items-center">
                <div>
                    <span class="data-label">Problema Principal</span>
                    <span class="data-value alert-value">{{ interno.get_porcualingresa_display }}</span>
                </div>
                <div class="text-end">
                    <span class="data-label">Fecha</span>
                    <span class="data-value">
                        {% if hatencionpsf.instance.fecha %}
                            {{ hatencionpsf.instance.fecha|date:"d/m/Y" }}
                        {% else %}
                            {{ hatencionpsf.fecha.value|default:"Nueva evaluación" }}
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulario principal -->
  <form action="{% url 'hojaAtencionPs' id=interno.numeroexpediente %}" method="POST">
    {% csrf_token %}
    <input type="hidden" name="expediente" value="{{ interno.numeroexpediente }}">

    <!-- MOSTRAR ERRORES DEL FORMULARIO -->
    {% if hatencionpsf.errors %}
    <div class="alert alert-danger mt-3">
      <h5><i class="bi bi-exclamation-triangle me-2"></i>Errores en el formulario:</h5>
      <ul class="mb-0">
        {% for field in hatencionpsf %}
          {% for error in field.errors %}
            <li><strong>{{ field.label }}:</strong> {{ error }}</li>
          {% endfor %}
        {% endfor %}
        {% for error in hatencionpsf.non_field_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <!-- Mensajes de alerta -->
    {% if messages %}
    <div class="alert-messages mt-3">
      {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        <i class="bi bi-info-circle me-2"></i>{{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Sección de captura -->
    <div class="card shadow-sm mt-3">
      <div class="card-header bg-light">
        <h5 class="mb-0">Evaluación Psicológica</h5>
      </div>

      <div class="card-body">
        <!-- Fecha y Psicólogo -->
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="{{ hatencionpsf.fecha.id_for_label }}" class="form-label fw-bold">
              {{ hatencionpsf.fecha.label }} *
            </label>
            {{ hatencionpsf.fecha }}
            {% if hatencionpsf.fecha.errors %}
              <div class="text-danger small">{{ hatencionpsf.fecha.errors }}</div>
            {% endif %}
          </div>
          <div class="col-md-6 mb-3">
            <label for="{{ hatencionpsf.psicologo.id_for_label }}" class="form-label fw-bold">
              {{ hatencionpsf.psicologo.label }}
            </label>
            {{ hatencionpsf.psicologo }}
            {% if hatencionpsf.psicologo.errors %}
              <div class="text-danger small">{{ hatencionpsf.psicologo.errors }}</div>
            {% endif %}
          </div>
        </div>

        <!-- Lateralidad -->
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold">Lateralidad</label>
            <div>
                {% for radio in hatencionpsf.lateralidad %}
                <div class="form-check form-check-inline">
                    {{ radio.tag }}
                    <label class="form-check-label" for="{{ radio.id_for_label }}">
                        {{ radio.choice_label }}
                    </label>
                </div>
                {% endfor %}
            </div>
            {% if hatencionpsf.lateralidad.errors %}
              <div class="text-danger small">{{ hatencionpsf.lateralidad.errors }}</div>
            {% endif %}
          </div>

          <!-- NUEVO CAMPO: Motivo agregado aquí -->
          <div class="col-md-6 mb-3">
            <label for="{{ hatencionpsf.motivo.id_for_label }}" class="form-label fw-bold">
              {{ hatencionpsf.motivo.label }}
            </label>
            {{ hatencionpsf.motivo }}
            {% if hatencionpsf.motivo.errors %}
              <div class="text-danger small">{{ hatencionpsf.motivo.errors }}</div>
            {% endif %}
          </div>
        </div>

        <!-- Antecedentes e Instrumentos -->
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="{{ hatencionpsf.antecedentes.id_for_label }}" class="form-label fw-bold">
              {{ hatencionpsf.antecedentes.label }}
            </label>
            {{ hatencionpsf.antecedentes }}
            {% if hatencionpsf.antecedentes.errors %}
              <div class="text-danger small">{{ hatencionpsf.antecedentes.errors }}</div>
            {% endif %}
          </div>
          <div class="col-md-6 mb-3">
            <label for="{{ hatencionpsf.instrumentos.id_for_label }}" class="form-label fw-bold">
              {{ hatencionpsf.instrumentos.label }}
            </label>
            {{ hatencionpsf.instrumentos }}
            {% if hatencionpsf.instrumentos.errors %}
              <div class="text-danger small">{{ hatencionpsf.instrumentos.errors }}</div>
            {% endif %}
          </div>
        </div>

        <!-- Observaciones y Resultados -->
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="{{ hatencionpsf.observaciones.id_for_label }}" class="form-label fw-bold">
              {{ hatencionpsf.observaciones.label }}
            </label>
            {{ hatencionpsf.observaciones }}
            {% if hatencionpsf.observaciones.errors %}
              <div class="text-danger small">{{ hatencionpsf.observaciones.errors }}</div>
            {% endif %}
          </div>
          <div class="col-md-6 mb-3">
            <label for="{{ hatencionpsf.resultados.id_for_label }}" class="form-label fw-bold">
              {{ hatencionpsf.resultados.label }}
            </label>
            {{ hatencionpsf.resultados }}
            {% if hatencionpsf.resultados.errors %}
              <div class="text-danger small">{{ hatencionpsf.resultados.errors }}</div>
            {% endif %}
          </div>
        </div>

        <!-- Diagnóstico -->
        <div class="row">
          <div class="col-12 mb-3">
            <label for="{{ hatencionpsf.diagnostico.id_for_label }}" class="form-label fw-bold">
              {{ hatencionpsf.diagnostico.label }}
            </label>
            {{ hatencionpsf.diagnostico }}
            {% if hatencionpsf.diagnostico.errors %}
              <div class="text-danger small">{{ hatencionpsf.diagnostico.errors }}</div>
            {% endif %}
          </div>
        </div>

        <!-- Botones de acción -->
        <div class="d-flex justify-content-between mt-4">
          <a href="{% url 'seleccionainterno' id=interno.numeroexpediente %}" class="btn btn-outline-secondary me-2">
            <i class="bi bi-arrow-left me-1"></i> Regresar
          </a>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-save me-1"></i> Guardar Evaluación
          </button>
        </div>
      </div>
    </div>
  </form>
</div>

<style>
.medical-badge {
    background: white;
    border: 2px solid #e3f2fd;
    border-radius: 12px;
    padding: 16px;
    font-family: 'Segoe UI', system-ui, sans-serif;
}

.medical-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid #f0f4f8;
}

.patient-id {
    display: flex;
    align-items: center;
    gap: 8px;
}

.id-label {
    font-size: 0.7rem;
    color: #6c757d;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.id-number {
    font-size: 1.1rem;
    font-weight: 700;
    color: #1976d2;
}

.patient-name {
    font-size: 1rem;
    font-weight: 600;
    color: #2c3e50;
}

.medical-data {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.data-row {
    display: flex;
    gap: 16px;
}

.data-point, .data-point-full {
    flex: 1;
}

.data-point-full {
    margin-top: 4px;
}

.data-label {
    display: block;
    font-size: 0.75rem;
    color: #6c757d;
    font-weight: 500;
    margin-bottom: 2px;
}

.data-value {
    display: block;
    font-size: 0.9rem;
    font-weight: 600;
    color: #2c3e50;
}

.alert-value {
    color: #d32f2f;
    font-weight: 700;
}
</style>

</body>
{% endblock %}